<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>3-30-300 Index Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://talea-platform.github.io/3-30-300-index/" />
    <meta property="og:title" content="The 3-30-300 rule describes three basic conditions for everyday access to urban nature from peopleâ€™s homes" />
    <meta property="og:description" content="The 3-30-300 rule describes three basic conditions for everyday access to urban nature from peopleâ€™s homes:
    3 â€“ at least three trees should be visible from a home.
    30 â€“ at least 30% of the neighbourhood area around the home should be covered by trees or other urban green.
    300 â€“ a public park or garden should be within 300 metres walking distance from the home.
Indicators in this dashboard are computed at statistical-area level. Tree visibility and neighbourhood green cover are estimated using Copernicus satellite imagery, combined with open data from the Municipality of Bologna (buildings, statistical areas and public green areas)." />
    <meta property="og:image" content="assets/images/preview.png" />

    <!-- X (Twitter) -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://talea-platform.github.io/3-30-300-index" />
    <meta property="twitter:title" content="The 3-30-300 rule describes three basic conditions for everyday access to urban nature from peopleâ€™s homes" />
    <meta property="twitter:description" content="The 3-30-300 rule describes three basic conditions for everyday access to urban nature from peopleâ€™s homes:
    3 â€“ at least three trees should be visible from a home.
    30 â€“ at least 30% of the neighbourhood area around the home should be covered by trees or other urban green.
    300 â€“ a public park or garden should be within 300 metres walking distance from the home.
Indicators in this dashboard are computed at statistical-area level. Tree visibility and neighbourhood green cover are estimated using Copernicus satellite imagery, combined with open data from the Municipality of Bologna (buildings, statistical areas and public green areas)." />
    <meta property="twitter:image" content="assets/images/preview.png" />


    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/images/favicon-16x16.png">
    <link rel="manifest" href="assets/images/site.webmanifest">


    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Tabler CSS -->
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler-vendors.min.css" rel="stylesheet"/>

  <!-- MapLibre -->
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet"/>
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jQuery + DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>

  <style>
    :root {
      --talea-green-dark: #17361c;
      --talea-blue: #3673c0;
      --talea-green: #38b850;
      --talea-yellow: #f7e91a;
      --talea-grey: #d1d1d1;
    }

    body { background-color: #f5f7fb; }

    .page-header {
      background: #ffffff;
      color: var(--talea-green-dark);
      padding: 1.5rem 0 1.25rem 0;
      margin-bottom: 0.5rem;
      border-bottom: 3px solid var(--talea-green);
    }

    .page-header .navbar-brand-text {
      color: var(--talea-blue);
      font-weight: 600;
      letter-spacing: .03em;
      text-transform: uppercase;
      font-size: .9rem;
    }

    .page-header-subtitle {
      font-size: .95rem;
      opacity: .9;
    }

    .header-logo {
      height: 60px;
      margin-right: 0.75rem;
    }

    #map-main {
      width: 100%;
      height: 420px;
      border-radius: 10px;
    }

    footer {
      border-top: 1px solid #e5e7f0;
      margin-top: 2rem;
      padding: 1.5rem 0;
      font-size: .8rem;
      color: #6c757d;
    }

    /* Legenda mappa orizzontale */
    .legend {
      margin-top: .75rem;
      font-size: .8rem;
      display: flex;
      flex-wrap: wrap;
      gap: .5rem .75rem;
      align-items: center;
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
    }
    .legend-color {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      margin-right: .35rem;
      border: 1px solid #ccc;
    }

    /* Palette legenda */
    .legend-color.score-0 { background-color: var(--talea-grey); }
    .legend-color.score-1 { background-color: var(--talea-yellow); }
    .legend-color.score-2 { background-color: var(--talea-blue); }
    .legend-color.score-3 { background-color: var(--talea-green); }

    .legend-color.canopy-0 { background-color: #f7fcf5; }
    .legend-color.canopy-1 { background-color: #e5f5e0; }
    .legend-color.canopy-2 { background-color: #a1d99b; }
    .legend-color.canopy-3 { background-color: #31a354; }
    .legend-color.canopy-4 { background-color: #006d2c; }

    .legend-color.bin-yes { background-color: var(--talea-green); }
    .legend-color.bin-no  { background-color: var(--talea-grey); }

    .card {
      border: 1px solid var(--talea-yellow);
    }

    .card-title {
      color: var(--talea-blue);
    }

    .subheader {
      color: var(--talea-blue);
      text-transform: uppercase;
      letter-spacing: .05em;
      font-size: .75rem;
      font-weight: 600;
    }

    .btn-lang {
      border-color: var(--talea-blue);
      color: var(--talea-blue);
      background-color: #ffffff;
    }
    .btn-lang.active {
      background-color: var(--talea-blue);
      color: #ffffff;
    }

    .val-yes {
      color: var(--talea-green);
      font-weight: 600;
    }
    .val-no {
      color: #d9534f;
      font-weight: 600;
    }

    table.dataTable tbody tr:hover {
      background-color: #f0f4ff;
    }
    #areas-table thead th {
      color: var(--talea-blue);
    }

    .table-legend {
      font-size: .75rem;
      margin-top: .25rem;
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
    }
    .table-legend-item {
      display: inline-flex;
      align-items: center;
      gap: .25rem;
    }

    .top-nav {
      border-bottom: 1px solid #e5e7f0;
      background-color: #ffffff;
      margin-bottom: 1rem;
    }
    .navbar-toggler {
      border-color: var(--talea-blue);
    }
    .navbar-toggler-icon {
      display: inline-block;
      width: 1.5em;
      height: 1.5em;
      position: relative;
    }
    .navbar-toggler-icon::before,
    .navbar-toggler-icon::after,
    .navbar-toggler-icon span {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background-color: var(--talea-blue);
    }
    .navbar-toggler-icon::before { top: 0; }
    .navbar-toggler-icon::after { bottom: 0; }
    .navbar-toggler-icon span {
      top: 50%;
      transform: translateY(-50%);
    }

    /* Chart sizing */
    .chart-container {
      width: 100%;
      height: 180px;
    }
  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <header class="page-header">
    <div class="container-xl">
      <div class="d-flex align-items-center justify-content-between">
        <div>
          <div class="d-flex align-items-center mb-1">
            <img src="assets/talea-logo.svg" alt="Talea logo" class="header-logo">
            <div>
              <div class="navbar-brand mb-0">
                <span class="navbar-brand-text" data-i18n="header.brand"></span>
              </div>
              <h1 class="h2 mb-0" data-i18n="header.title"></h1>
            </div>
          </div>
          <p class="page-header-subtitle mb-0" data-i18n="header.subtitle"></p>
        </div>
        <div class="text-end">
          <div class="btn-group" role="group" aria-label="Language switch">
            <button id="lang-en" class="btn btn-sm btn-lang active" type="button">ðŸ‡¬ðŸ‡§ EN</button>
            <button id="lang-it" class="btn btn-sm btn-lang" type="button">ðŸ‡®ðŸ‡¹ IT</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- NAVBAR / HAMBURGER -->
  <nav class="navbar navbar-expand-md top-nav">
    <div class="container-xl">
      <a class="navbar-brand d-md-none" href="#">3-30-300</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu"
              aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"><span></span></span>
      </button>
      <div class="collapse navbar-collapse" id="navbar-menu">
        <ul class="navbar-nav ms-auto small">
          <li class="nav-item">
            <a class="nav-link" href="#sec-overview" data-i18n="nav.overview"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#sec-summary" data-i18n="nav.summary"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#sec-map" data-i18n="nav.map"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#sec-table" data-i18n="nav.table"></a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#modal-project" data-i18n="nav.modal"></a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="page-body">
      <div class="container-xl">

        <!-- OVERVIEW -->
        <div id="sec-overview" class="row row-cards mb-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h3 class="card-title mb-2" data-i18n="overview.title"></h3>
                <p class="text-muted mb-0"><span data-i18n="overview.text"></span>&nbsp;<a href="https://link.springer.com/article/10.1007/s11676-022-01523-z">Evidence-based guidelines for greener, healthier, more resilient neighbourhoods: Introducing the 3â€“30â€“300 rule</a></p>
              </div>
            </div>
          </div>
        </div>

        <!-- SUMMARY CARDS -->
        <div id="sec-summary" class="row row-cards">
          <div class="col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="subheader" data-i18n="card3.sub"></div>
                <div class="h1 mb-1" id="summary-3">-- %</div>
                <p class="text-muted mb-0" data-i18n="card3.text"></p>
              </div>
            </div>
          </div>

          <div class="col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="subheader" data-i18n="card30.sub"></div>
                <div class="h1 mb-1" id="summary-30">-- %</div>
                <p class="text-muted mb-0" data-i18n="card30.text"></p>
              </div>
            </div>
          </div>

          <div class="col-sm-4">
            <div class="card">
              <div class="card-body">
                <div class="subheader" data-i18n="card300.sub"></div>
                <div class="h1 mb-1" id="summary-300">-- %</div>
                <p class="text-muted mb-0" data-i18n="card300.text"></p>
              </div>
            </div>
          </div>
        </div>

        <!-- CARD 1: TRE BARCHART (AFFIANCATI) -->
        <div id="sec-map" class="row row-cards mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h3 class="card-title mb-2" data-i18n="summary.score.title"></h3>
                <p class="text-muted" data-i18n="summary.score.text"></p>
                <div class="row">
                  <div class="col-md-4">
                    <h4 class="card-title mb-1" style="font-size:.9rem;" data-i18n="chart.perc.title"></h4>
                    <canvas id="chart-percentages" class="chart-container"></canvas>
                  </div>
                  <div class="col-md-4">
                    <h4 class="card-title mb-1" style="font-size:.9rem;" data-i18n="chart.dist.title"></h4>
                    <canvas id="chart-distribution" class="chart-container"></canvas>
                  </div>
                  <div class="col-md-4">
                    <h4 class="card-title mb-1" style="font-size:.9rem;" data-i18n="chart.progress.title"></h4>
                    <canvas id="progress" class="chart-container"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CARD 2: MAPPA SOTTO I GRAFICI -->
          <div class="col-12 mt-3">
            <div class="card">
              <ul class="nav nav-tabs" id="map-tabs">
                <li class="nav-item">
                  <a class="nav-link active" href="#" data-map-mode="score" data-i18n="map.tab.score"></a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-map-mode="c3" data-i18n="map.tab.c3"></a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-map-mode="c30" data-i18n="map.tab.c30"></a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-map-mode="c300" data-i18n="map.tab.c300"></a>
                </li>
              </ul>
              <div class="card-body">
                <div class="d-flex align-items-center mb-2">
                  <label for="opacity-range" class="me-2 small text-muted" data-i18n="map.opacity"></label>
                  <input type="range" id="opacity-range" min="10" max="100" value="70">
                </div>
                <h3 class="card-title mb-2" data-i18n="map.main.title"></h3>
                <p class="text-muted mb-2" data-i18n="map.main.text"></p>
                <div id="map-main"></div>
                <div id="map-legend" class="legend"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- CARD 3: TABELLA SOTTO LA MAPPA -->
        <div id="sec-table" class="row row-cards mt-4">
          <div class="col-12">
            <div class="card">
              <div class="card-header">
                <div>
                  <h3 class="card-title" data-i18n="table.title"></h3>
                  <div class="table-legend">
                    <span class="table-legend-item">
                      <strong>3</strong>
                      <span data-i18n="table.legend.3"></span>
                    </span>
                    <span class="table-legend-item">
                      <strong>30</strong>
                      <span data-i18n="table.legend.30"></span>
                    </span>
                    <span class="table-legend-item">
                      <strong>300</strong>
                      <span data-i18n="table.legend.300"></span>
                    </span>
                    <span class="table-legend-item">
                      <span class="val-yes">âœ”</span>
                      <span data-i18n="table.legend.yes"></span>
                    </span>
                    <span class="table-legend-item">
                      <span class="val-no">âœ–</span>
                      <span data-i18n="table.legend.no"></span>
                    </span>
                  </div>
                </div>
              </div>
              <div class="table-responsive">
                <table id="areas-table" class="table table-vcenter card-table display">
                  <thead>
                  <tr>
                    <th data-i18n="table.h.id"></th>
                    <th data-i18n="table.h.area"></th>
                    <th data-i18n="table.h.c3"></th>
                    <th data-i18n="table.h.c30"></th>
                    <th data-i18n="table.h.c300"></th>
                    <th data-i18n="table.h.score"></th>
                  </tr>
                  </thead>
                  <tbody id="areas-table-body"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- FOOTER -->
        <footer>
          <div class="container-xl">
            <div class="row">
              <div class="col-md-8">
                <span data-i18n="footer.text"></span>
              </div>
              <div class="col-md-4 text-md-end mt-2 mt-md-0">
                <a href="https://talea-platform.github.io" target="_blank" rel="noopener"
                   class="text-decoration-none" data-i18n="footer.maintainer"></a>
              </div>
            </div>
          </div>
        </footer>

      </div>
    </div>
  </div>
</div>

<!-- MODAL ABOUT -->
<div class="modal modal-blur fade" id="modal-project" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="modal.project.title"></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- What is the 3-30-300 index? -->
        <div class="mb-3">
          <h5 data-i18n="intro.title"></h5>
          <p class="text-muted mb-2" data-i18n="intro.p1"></p>
          <ul class="text-muted mb-2">
            <li data-i18n="intro.li3"></li>
            <li data-i18n="intro.li30"></li>
            <li data-i18n="intro.li300"></li>
          </ul>
          <p class="text-muted mb-0" data-i18n="intro.p2"></p>
        </div>
        <hr>
        <!-- How to read this dashboard -->
        <div>
          <h5 data-i18n="intro2.title"></h5>
          <p class="text-muted mb-0" data-i18n="intro2.p"></p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" data-bs-dismiss="modal" type="button" data-i18n="modal.close"></button>
      </div>
    </div>
  </div>
</div>

<!-- Tabler JS -->
<script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>

<script>
const translations = {
  en: {
    /* HEADER */
    "header.brand": "Urban Green Accessibility",
    "header.title": "3-30-300 Index Dashboard",
    "header.subtitle": "Exploring everyday access to urban nature in Bologna.",

    /* OVERVIEW */
    "overview.title": "3-30-300 in Bologna neighbourhoods",
    "overview.text":
      "Here you can explore how the 3-30-300 rule applies to the neighbourhoods of Bologna. â€œ3â€ is the minimum number of trees that should be visible from a home, â€œ30â€ is the minimum percentage of green cover in the neighbourhood where the home is located, and â€œ300â€ is the maximum walking distance to reach a public park. For more details, see the article",
    /* NAVIGATION */
    "nav.overview": "Overview",
    "nav.summary": "Summary indicators",
    "nav.map": "Maps & charts",
    "nav.table": "Table",
    "nav.modal": "About 3-30-300",

    /* ABOUT (modal) */
    "intro.title": "What is the 3-30-300 rule?",
    "intro.p1":
      "The 3-30-300 rule describes three basic conditions for everyday access to urban nature from peopleâ€™s homes:",
    "intro.li3": "3 â€“ at least three trees should be visible from a home.",
    "intro.li30":
      "30 â€“ at least 30% of the neighbourhood area around the home should be covered by trees or other urban green.",
    "intro.li300":
      "300 â€“ a public park or garden should be within 300 metres walking distance from the home.",
    "intro.p2":
      "Indicators in this dashboard are computed at statistical-area level. Tree visibility and neighbourhood green cover are estimated using Copernicus satellite imagery, combined with open data from the Municipality of Bologna (buildings, statistical areas and public green areas).",

    "intro2.title": "How to read this dashboard",
    "intro2.p":
      "Summary cards show the share of areas meeting each condition. Charts illustrate the distribution of 3-30-300 scores. The map tabs allow switching between the overall score and the three individual conditions. The table reports detailed values for each statistical area.",

    /* SUMMARY CARDS */
    "card3.sub": "Condition 3",
    "card3.text": "Areas where homes have visibility of at least three trees.",

    "card30.sub": "Condition 30",
    "card30.text": "Areas where at least 30% of the neighbourhood is covered by green.",

    "card300.sub": "Condition 300",
    "card300.text": "Areas where a public park is reachable within 300 metres.",

    /* CHARTS */
    "chart.perc.title": "Areas meeting 3 / 30 / 300",
    "chart.dist.title": "Areas by score (0â€“3)",
    "chart.progress.title": "% of areas by score",

    "summary.score.title": "Distribution of 3-30-300 scores",
    "summary.score.text":
      "The charts below show how many of the three 3-30-300 conditions are met in each statistical area, and how the distribution of scores is structured across the city.",

    /* MAP */
    "map.tab.score": "Score (0â€“3)",
    "map.tab.c3": "Condition 3",
    "map.tab.c30": "Condition 30",
    "map.tab.c300": "Condition 300",

    "map.main.title": "Map â€“ 3-30-300 views",
    "map.main.text":
      "Use the tabs to switch between the 3-30-300 score and the individual conditions (3 trees visible, 30% green cover, 300-metre access to a public park). Click on an area to view detailed indicators.",
    "map.opacity": "Layer opacity",

    /* LEGEND â€“ SCORE */
    "legend.score.c0": "Score 0 â€“ none of the 3-30-300 conditions are met.",
    "legend.score.c1": "Score 1 â€“ one 3-30-300 condition is met.",
    "legend.score.c2": "Score 2 â€“ two 3-30-300 conditions are met.",
    "legend.score.c3": "Score 3 â€“ all three 3-30-300 conditions are met.",

    /* LEGEND â€“ CANOPY */
    "legend.canopy.0": "0â€“10% green cover",
    "legend.canopy.1": "10â€“30% green cover",
    "legend.canopy.2": "30â€“60% green cover",
    "legend.canopy.3": "60â€“90% green cover",
    "legend.canopy.4": "90â€“100% green cover",

    /* LEGEND â€“ BINARY CONDITIONS */
    "legend.c3.yes": "Condition 3 met",
    "legend.c3.no": "Condition 3 not met",
    "legend.c300.yes": "Condition 300 met",
    "legend.c300.no": "Condition 300 not met",

    /* TABLE */
    "table.title": "Indicators by statistical area",
    "table.h.id": "ID",
    "table.h.area": "Area",
    "table.h.c3": "3",
    "table.h.c30": "30",
    "table.h.c300": "300",
    "table.h.score": "Score",

    "table.legend.3": "â‰¥3 trees visible",
    "table.legend.30": "â‰¥30% green cover",
    "table.legend.300": "â‰¤300 m to public park",
    "table.legend.yes": "condition met",
    "table.legend.no": "condition not met",

    /* FOOTER */
    "footer.text":
      "Dashboard for exploring the 3-30-300 rule in Bologna using satellite data and municipal open data.",
    "footer.maintainer": "Talea Project",

    /* MODAL */
    "modal.project.title": "About the 3-30-300 rule",
    "modal.close": "Close",

    /* POPUP */
    "popup.name": "Area",
    "popup.id": "ID",
    "popup.score": "Score",
    "popup.c3": "Condition 3",
    "popup.c30": "Condition 30",
    "popup.c300": "Condition 300",
    "popup.canopy": "Green cover"
  },

  /* ---------------------------------------------------------------------------------------- */

  it: {
    /* HEADER */
    "header.brand": "AccessibilitÃ  al verde urbano",
    "header.title": "Dashboard indice 3-30-300",
    "header.subtitle": "Esplorare lâ€™accesso quotidiano alla natura urbana a Bologna.",

    /* OVERVIEW */
    "overview.title": "La regola 3-30-300 nei quartieri di Bologna",
    "overview.text":
      "Qui puoi scoprire la regola del 3-30-300 nei quartieri della cittÃ  di Bologna. â€œ3â€ Ã¨ il numero minimo di alberi visibili da unâ€™abitazione, â€œ30â€ Ã¨ la percentuale minima di verde dellâ€™area del quartiere dove si trova la casa e â€œ300â€ Ã¨ la distanza massima in metri per raggiungere un parco pubblico. Per saperne di piÃ¹, leggi lâ€™articolo",

    /* NAVIGATION */
    "nav.overview": "Panoramica",
    "nav.summary": "Indicatori di sintesi",
    "nav.map": "Mappe e grafici",
    "nav.table": "Tabella",
    "nav.modal": "Informazioni 3-30-300",

    /* ABOUT (modal) */
    "intro.title": "Che cosâ€™Ã¨ la regola 3-30-300?",
    "intro.p1":
      "La regola 3-30-300 descrive tre condizioni fondamentali per lâ€™accesso quotidiano al verde urbano a partire dalle abitazioni:",
    "intro.li3": "3 â€“ da ogni abitazione dovrebbero essere visibili almeno tre alberi.",
    "intro.li30":
      "30 â€“ almeno il 30% del quartiere in cui si trova la casa dovrebbe essere coperto da alberi o altro verde urbano.",
    "intro.li300":
      "300 â€“ un parco o giardino pubblico dovrebbe trovarsi entro 300 metri di distanza a piedi dallâ€™abitazione.",
    "intro.p2":
      "Gli indicatori sono calcolati a livello di area statistica. La visibilitÃ  degli alberi e la copertura verde del quartiere sono stimate tramite immagini satellitari Copernicus, combinate con gli open data del Comune di Bologna (edifici, aree statistiche e aree verdi pubbliche).",

    "intro2.title": "Come leggere questa dashboard",
    "intro2.p":
      "Le card di sintesi mostrano la quota di aree che soddisfa ciascuna condizione. I grafici illustrano la distribuzione dei punteggi 3-30-300. Le tab della mappa permettono di passare dal punteggio complessivo alle tre condizioni. La tabella riporta i valori dettagliati per ogni area statistica.",

    /* SUMMARY CARDS */
    "card3.sub": "Condizione 3",
    "card3.text": "Aree in cui dalle abitazioni sono visibili almeno tre alberi.",

    "card30.sub": "Condizione 30",
    "card30.text": "Aree in cui almeno il 30% del quartiere Ã¨ coperto da verde.",

    "card300.sub": "Condizione 300",
    "card300.text": "Aree in cui un parco pubblico Ã¨ raggiungibile entro 300 metri.",

    /* CHARTS */
    "chart.perc.title": "Aree che soddisfano 3 / 30 / 300",
    "chart.dist.title": "Aree per punteggio (0â€“3)",
    "chart.progress.title": "% di aree per punteggio",

    "summary.score.title": "Distribuzione dei punteggi 3-30-300",
    "summary.score.text":
      "I grafici sottostanti mostrano quante delle tre condizioni della regola 3-30-300 sono soddisfatte in ciascuna area statistica e come si distribuiscono i punteggi nella cittÃ .",

    /* MAP */
    "map.tab.score": "Punteggio (0â€“3)",
    "map.tab.c3": "Condizione 3",
    "map.tab.c30": "Condizione 30",
    "map.tab.c300": "Condizione 300",

    "map.main.title": "Mappa â€“ viste dellâ€™indice 3-30-300",
    "map.main.text":
      "Utilizza le tab per passare dal punteggio complessivo 3-30-300 alle tre condizioni (3 alberi visibili, 30% di verde nel quartiere, 300 metri per raggiungere un parco pubblico). Clicca su unâ€™area per visualizzarne gli indicatori.",
    "map.opacity": "Trasparenza layer",

    /* LEGEND â€“ SCORE */
    "legend.score.c0": "Punteggio 0 â€“ nessuna delle condizioni 3-30-300 Ã¨ soddisfatta.",
    "legend.score.c1": "Punteggio 1 â€“ una delle condizioni 3-30-300 Ã¨ soddisfatta.",
    "legend.score.c2": "Punteggio 2 â€“ due delle condizioni 3-30-300 sono soddisfatte.",
    "legend.score.c3": "Punteggio 3 â€“ tutte e tre le condizioni 3-30-300 sono soddisfatte.",

    /* LEGEND â€“ CANOPY */
    "legend.canopy.0": "0â€“10% copertura verde",
    "legend.canopy.1": "10â€“30% copertura verde",
    "legend.canopy.2": "30â€“60% copertura verde",
    "legend.canopy.3": "60â€“90% copertura verde",
    "legend.canopy.4": "90â€“100% copertura verde",

    /* LEGEND â€“ BINARY */
    "legend.c3.yes": "Condizione 3 soddisfatta",
    "legend.c3.no": "Condizione 3 non soddisfatta",
    "legend.c300.yes": "Condizione 300 soddisfatta",
    "legend.c300.no": "Condizione 300 non soddisfatta",

    /* TABLE */
    "table.title": "Indicatori per area statistica",
    "table.h.id": "ID",
    "table.h.area": "Area",
    "table.h.c3": "3",
    "table.h.c30": "30",
    "table.h.c300": "300",
    "table.h.score": "Punteggio",

    "table.legend.3": "â‰¥3 alberi visibili",
    "table.legend.30": "â‰¥30% copertura verde",
    "table.legend.300": "â‰¤300 m da un parco pubblico",
    "table.legend.yes": "condizione soddisfatta",
    "table.legend.no": "condizione non soddisfatta",

    /* FOOTER */
    "footer.text":
      "Dashboard per esplorare la regola 3-30-300 a Bologna tramite immagini satellitari e open data comunali.",
    "footer.maintainer": "Talea Project",

    /* MODAL */
    "modal.project.title": "Informazioni sulla regola 3-30-300",
    "modal.close": "Chiudi",

    /* POPUP */
    "popup.name": "Area",
    "popup.id": "ID",
    "popup.score": "Punteggio",
    "popup.c3": "Condizione 3",
    "popup.c30": "Condizione 30",
    "popup.c300": "Condizione 300",
    "popup.canopy": "Copertura verde"
  }
};


let currentLang = "en";
let mapMain = null;
let currentMapMode = "score";

function applyTranslations(lang) {
  document.querySelectorAll("[data-i18n]").forEach(el => {
    const key = el.getAttribute("data-i18n");
    if (translations[lang][key] !== undefined) {
      el.textContent = translations[lang][key];
    }
  });
  document.querySelectorAll(".btn-lang").forEach(btn => btn.classList.remove("active"));
  document.getElementById("lang-" + lang).classList.add("active");
  currentLang = lang;
  if (typeof updateLegend === "function") updateLegend(currentMapMode);
}

document.getElementById("lang-en").addEventListener("click", () => applyTranslations("en"));
document.getElementById("lang-it").addEventListener("click", () => applyTranslations("it"));

function updateLegend(mode) {
  currentMapMode = mode;
  const el = document.getElementById("map-legend");
  if (!el) return;
  const t = translations[currentLang];
  if (mode === "score") {
    el.innerHTML = `
      <span class="legend-item"><span class="legend-color score-0"></span>${t["legend.score.c0"]}</span>
      <span class="legend-item"><span class="legend-color score-1"></span>${t["legend.score.c1"]}</span>
      <span class="legend-item"><span class="legend-color score-2"></span>${t["legend.score.c2"]}</span>
      <span class="legend-item"><span class="legend-color score-3"></span>${t["legend.score.c3"]}</span>
    `;
  } else if (mode === "c30") {
    el.innerHTML = `
      <span class="legend-item"><span class="legend-color canopy-0"></span>${t["legend.canopy.0"]}</span>
      <span class="legend-item"><span class="legend-color canopy-1"></span>${t["legend.canopy.1"]}</span>
      <span class="legend-item"><span class="legend-color canopy-2"></span>${t["legend.canopy.2"]}</span>
      <span class="legend-item"><span class="legend-color canopy-3"></span>${t["legend.canopy.3"]}</span>
      <span class="legend-item"><span class="legend-color canopy-4"></span>${t["legend.canopy.4"]}</span>
    `;
  } else if (mode === "c3") {
    el.innerHTML = `
      <span class="legend-item"><span class="legend-color bin-yes"></span>${t["legend.c3.yes"]}</span>
      <span class="legend-item"><span class="legend-color bin-no"></span>${t["legend.c3.no"]}</span>
    `;
  } else if (mode === "c300") {
    el.innerHTML = `
      <span class="legend-item"><span class="legend-color bin-yes"></span>${t["legend.c300.yes"]}</span>
      <span class="legend-item"><span class="legend-color bin-no"></span>${t["legend.c300.no"]}</span>
    `;
  }
}

async function loadData() {
  applyTranslations(currentLang);

  const res = await fetch("data/3-30-300-index.geojson");
  const geojson = await res.json();
  const features = geojson.features;

  const featureById = {};
  features.forEach(f => {
    featureById[f.properties.stat_area_id] = f;
  });

  const perc = field =>
    100 * (features.filter(f => f.properties[field] === true).length / features.length);

  const p3 = perc("meet_3");
  const p30 = perc("meet_30");
  const p300 = perc("meet_300");

  document.getElementById("summary-3").textContent = p3.toFixed(1) + "%";
  document.getElementById("summary-30").textContent = p30.toFixed(1) + "%";
  document.getElementById("summary-300").textContent = p300.toFixed(1) + "%";

  const dist = {0:0,1:0,2:0,3:0};
  features.forEach(f => {
    const k = f.properties.num_conditions_met;
    if (dist.hasOwnProperty(k)) dist[k] += 1;
  });

  const totalAreas = features.length;
  const pct0 = 100 * dist[0] / totalAreas;
  const pct1 = 100 * dist[1] / totalAreas;
  const pct2 = 100 * dist[2] / totalAreas;
  const pct3 = 100 * dist[3] / totalAreas;

  // TABLE
  const tbody = document.getElementById("areas-table-body");
  features.forEach(f => {
    const p = f.properties;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.stat_area_id}</td>
      <td>${p.stat_area_name}</td>
      <td><span class="${p.meet_3 ? "val-yes" : "val-no"}">${p.meet_3 ? "âœ”" : "âœ–"}</span></td>
      <td><span class="${p.meet_30 ? "val-yes" : "val-no"}">${p.meet_30 ? "âœ”" : "âœ–"}</span></td>
      <td><span class="${p.meet_300 ? "val-yes" : "val-no"}">${p.meet_300 ? "âœ”" : "âœ–"}</span></td>
      <td>${p.num_conditions_met}</td>
    `;
    tbody.appendChild(tr);
  });

  const table = $('#areas-table').DataTable({
    paging: true,
    searching: true,
    info: true,
    order: [[5, 'desc']]
  });

  const taleaGreen = "#38b850";

  // chart-percentages (colori coerenti con mappa: giallo / blu / verde)
  const ctxPerc = document.getElementById("chart-percentages").getContext("2d");
  new Chart(ctxPerc, {
    type: 'bar',
    data: {
      labels: ['3', '30', '300'],
      datasets: [{
        data: [p3, p30, p300],
        backgroundColor: [
          '#f7e91a', // 3
          '#3673c0', // 30
          '#38b850'  // 300
        ]
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v + '%' }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // chart-distribution (sempre verde talea)
  const ctxDist = document.getElementById("chart-distribution").getContext("2d");
  new Chart(ctxDist, {
    type: 'bar',
    data: {
      labels: ['0','1','2','3'],
      datasets: [{
        data: [dist[0], dist[1], dist[2], dist[3]],
        backgroundColor: taleaGreen
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: { beginAtZero: true },
        x: { grid: { display: false } }
      }
    }
  });

  // progress (bar verticale % per punteggio)
  const ctxProg = document.getElementById("progress").getContext("2d");
  new Chart(ctxProg, {
    type: 'bar',
    data: {
      labels: ['0','1','2','3'],
      datasets: [{
        data: [pct0, pct1, pct2, pct3],
        backgroundColor: taleaGreen
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v + '%' }
        },
        x: { grid: { display: false } }
      }
    }
  });

  // funzione bounds ricorsiva
  function extendBoundsGeneric(coords, b) {
    if (typeof coords[0] === 'number') {
      b.extend(coords);
    } else {
      coords.forEach(c => extendBoundsGeneric(c, b));
    }
  }

  const bounds = new maplibregl.LngLatBounds();
  features.forEach(f => extendBoundsGeneric(f.geometry.coordinates, bounds));

  // MAPPA
  mapMain = new maplibregl.Map({
    container: 'map-main',
    style: 'https://tiles.openfreemap.org/styles/liberty',
    center: [11.343, 44.494],
    zoom: 11
  });

  mapMain.addControl(new maplibregl.FullscreenControl(), 'top-right');

  mapMain.on('load', () => {
    mapMain.addSource("areas", { type: "geojson", data: geojson });

    mapMain.addLayer({
      id: "areas-score-fill",
      type: "fill",
      source: "areas",
      paint: {
        "fill-color": [
          "match",
          ["get", "num_conditions_met"],
          0, "#d1d1d1",
          1, "#f7e91a",
          2, "#3673c0",
          3, "#38b850",
          "#cccccc"
        ],
        "fill-opacity": 0.7
      }
    });

    mapMain.addLayer({
      id: "areas-c3-fill",
      type: "fill",
      source: "areas",
      paint: {
        "fill-color": [
          "case",
          ["==", ["get", "meet_3"], true],
          "#38b850",
          "#d1d1d1"
        ],
        "fill-opacity": 0.7
      },
      layout: { "visibility": "none" }
    });

    mapMain.addLayer({
      id: "areas-c30-fill",
      type: "fill",
      source: "areas",
      paint: {
        "fill-color": [
          "interpolate",
          ["linear"],
          ["get", "perc_canopy_cover_30"],
          0,   "#f7fcf5",
          10,  "#e5f5e0",
          30,  "#a1d99b",
          60,  "#31a354",
          90,  "#006d2c"
        ],
        "fill-opacity": 0.7
      },
      layout: { "visibility": "none" }
    });

    mapMain.addLayer({
      id: "areas-c300-fill",
      type: "fill",
      source: "areas",
      paint: {
        "fill-color": [
          "case",
          ["==", ["get", "meet_300"], true],
          "#38b850",
          "#d1d1d1"
        ],
        "fill-opacity": 0.7
      },
      layout: { "visibility": "none" }
    });

    mapMain.addLayer({
      id: "areas-outline",
      type: "line",
      source: "areas",
      paint: {
        "line-color": "#333333",
        "line-width": 0.8
      }
    });

    mapMain.fitBounds(bounds, { padding: 20 });
    updateLegend("score");

    const popup = new maplibregl.Popup({
      closeButton: true,
      closeOnClick: true
    });

    function onFeatureClick(e) {
      const f = e.features[0];
      if (!f) return;
      const p = f.properties;
      const t = translations[currentLang];
      const yes = '<span style="color:#38b850;font-weight:600;">âœ”</span>';
      const no  = '<span style="color:#d9534f;font-weight:600;">âœ–</span>';
      const canopyVal = (typeof p.perc_canopy_cover_30 === "number")
        ? p.perc_canopy_cover_30.toFixed(1)
        : p.perc_canopy_cover_30;
      const html = `
        <strong>${t["popup.name"]}:</strong> ${p.stat_area_name}<br/>
        <strong>${t["popup.id"]}:</strong> ${p.stat_area_id}<br/>
        <strong>${t["popup.score"]}:</strong> ${p.num_conditions_met}<br/>
        <strong>${t["popup.c3"]}:</strong> ${p.meet_3 ? yes : no}<br/>
        <strong>${t["popup.c30"]}:</strong> ${p.meet_30 ? yes : no}<br/>
        <strong>${t["popup.c300"]}:</strong> ${p.meet_300 ? yes : no}<br/>
        <strong>${t["popup.canopy"]}:</strong> ${canopyVal}% 
      `;
      popup
        .setLngLat(e.lngLat)
        .setHTML(html)
        .addTo(mapMain);
    }

    ["areas-score-fill","areas-c3-fill","areas-c30-fill","areas-c300-fill"].forEach(layerId => {
      mapMain.on("click", layerId, onFeatureClick);
      mapMain.on("mouseenter", layerId, () => { mapMain.getCanvas().style.cursor = "pointer"; });
      mapMain.on("mouseleave", layerId, () => { mapMain.getCanvas().style.cursor = ""; });
    });
  });

  // Slider opacitÃ 
  const opacitySlider = document.getElementById("opacity-range");
  opacitySlider.addEventListener("input", (e) => {
    const val = Number(e.target.value) / 100;
    if (!mapMain) return;
    ["areas-score-fill","areas-c3-fill","areas-c30-fill","areas-c300-fill"].forEach(layerId => {
      if (mapMain.getLayer(layerId)) {
        mapMain.setPaintProperty(layerId, "fill-opacity", val);
      }
    });
  });

  // Tabs mappa
  document.querySelectorAll("#map-tabs .nav-link").forEach(link => {
    link.addEventListener("click", ev => {
      ev.preventDefault();
      const mode = link.getAttribute("data-map-mode");
      document.querySelectorAll("#map-tabs .nav-link").forEach(l => l.classList.remove("active"));
      link.classList.add("active");
      setMapMode(mode);
    });
  });

  function setMapMode(mode) {
    currentMapMode = mode;
    const visibility = {
      score:  { "areas-score-fill": "visible", "areas-c3-fill": "none",   "areas-c30-fill": "none",   "areas-c300-fill": "none" },
      c3:     { "areas-score-fill": "none",    "areas-c3-fill": "visible","areas-c30-fill": "none",   "areas-c300-fill": "none" },
      c30:    { "areas-score-fill": "none",    "areas-c3-fill": "none",   "areas-c30-fill": "visible","areas-c300-fill": "none" },
      c300:   { "areas-score-fill": "none",    "areas-c3-fill": "none",   "areas-c30-fill": "none",   "areas-c300-fill": "visible" }
    }[mode];

    if (!visibility || !mapMain) return;
    Object.entries(visibility).forEach(([layerId, vis]) => {
      if (mapMain.getLayer(layerId)) {
        mapMain.setLayoutProperty(layerId, "visibility", vis);
      }
    });
    updateLegend(mode);
  }

  // click riga â†’ zoom su area
  $('#areas-table tbody').on('click', 'tr', function () {
    const rowData = table.row(this).data();
    if (!rowData) return;

    const statId = rowData[0];
    const feature = featureById[statId];
    if (!feature || !mapMain) return;

    const fbounds = new maplibregl.LngLatBounds();
    extendBoundsGeneric(feature.geometry.coordinates, fbounds);

    mapMain.fitBounds(fbounds, {
      padding: 40,
      maxZoom: 15
    });
  });
}

loadData();
</script>

</body>
</html>

